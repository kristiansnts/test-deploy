name: Deploy to AAPanel Test

on:
  push:
    tag: 'demo/*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build & Deploy Worker
        uses: cloudflare/wrangler-action@v4
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      
      - name: Deploy to AAPanel
        run: |
          echo "=== Started to AAPanel ==="
          echo "Triggering webhook..."
          response=$(curl -v -X POST \
            -H "User-Agent: GitHub-Actions-Deploy/1.0" \
            -H "Accept: application/json" \
            -H "Cache-Control: no-cache" \
            -w "\n\nHTTP Status: %{http_code}\nTotal Time: %{time_total}s\n" \
            ${{ secrets.AAPANEL_TRIGER }} 2>&1)
          echo "$response"
          if echo "$response" | grep -q "Just a moment"; then
            echo "‚ùå ERROR: Cloudflare challenge detected!"
            exit 1
          fi
          echo "=== Deploy to AAPanel Done ==="